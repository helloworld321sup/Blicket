// Global variables
let username = '';
const userCollection = JSON.parse(localStorage.getItem('userCollection')) || { Emojis: {}, Business: {}, Exotics: {}, Sports: {} };

// Packs with the provided blook weights
const packs = {
    Emojis: [
        { name: '😩', rarity: 'Uncommon', chance: 18.75 },
        { name: '😕', rarity: 'Uncommon', chance: 18.75 },
        { name: '🤨', rarity: 'Uncommon', chance: 18.75 },
        { name: '😗', rarity: 'Uncommon', chance: 18.75 },
        { name: '🤓', rarity: 'Rare', chance: 8.5 },
        { name: '😍', rarity: 'Rare', chance: 8.5 },
        { name: '😎', rarity: 'Epic', chance: 6 },
        { name: '🤯', rarity: 'Legendary', chance: 0.9 },
        { name: '🤬', rarity: 'Chroma', chance: 0.1 },
    ],
    Business: [
        { name: '🏷️', rarity: 'Uncommon', chance: 18.75 },
        { name: '📅', rarity: 'Uncommon', chance: 18.75 },
        { name: '📊', rarity: 'Uncommon', chance: 18.75 },
        { name: '💼', rarity: 'Uncommon', chance: 18.75 },
        { name: '💳', rarity: 'Rare', chance: 8.5 },
        { name: '🗑️', rarity: 'Rare', chance: 8.5 },
        { name: '💻', rarity: 'Epic', chance: 6 },
        { name: '👨🏻‍💼', rarity: 'Legendary', chance: 0.95 },
        { name: '🛒', rarity: 'Chroma', chance: 0.05 },
    ],
    Exotics: [
        { name: '🩵', rarity: 'Uncommon', chance: 16.25 },
        { name: '🤹‍♀️', rarity: 'Uncommon', chance: 16.25 },
        { name: '🎬', rarity: 'Uncommon', chance: 16.25 },
        { name: '🚛', rarity: 'Uncommon', chance: 16.25 },
        { name: '🚀', rarity: 'Rare', chance: 12.5 },
        { name: '🛳️', rarity: 'Rare', chance: 12.5 },
        { name: '🗽', rarity: 'Epic', chance: 8 },
        { name: '🌋', rarity: 'Legendary', chance: 1.79 },
        { name: '📀', rarity: 'Exotic', chance: 0.006 },
        { name: '💿', rarity: 'Exotic', chance: 0.004 },
    ],
    Sports: [
        { name: '⚽', rarity: 'Uncommon', chance: 18 },
        { name: '🏀', rarity: 'Uncommon', chance: 18 },
        { name: '🏈', rarity: 'Uncommon', chance: 18 },
        { name: '⚾', rarity: 'Uncommon', chance: 18 },
        { name: '🥊', rarity: 'Rare', chance: 6.25 },
        { name: '🎾', rarity: 'Rare', chance: 6.25 },
        { name: '🏒', rarity: 'Rare', chance: 6.25 },
        { name: '🏆', rarity: 'Epic', chance: 3.125 },
        { name: '🧢', rarity: 'Epic', chance: 3.125 },
        { name: '🥇', rarity: 'Legendary', chance: 1.799963 },
        { name: '🥏', rarity: 'Chroma', chance: 0.2 },
        { name: '🏄', rarity: 'Elusive', chance: 0.000037 },
    ]
};

// On page load, check if user is already logged in
window.onload = () => {
    const savedUsername = localStorage.getItem('username');
    if (savedUsername) {
        username = savedUsername;
        showGameScreen();
    }
};

// Handle login
function login() {
    const userInput = document.getElementById('username').value;
    if (userInput) {
        username = userInput;
        localStorage.setItem('username', username);
        showGameScreen();
    } else {
        alert('Please enter a username');
    }
}

// Show game screen and welcome message
function showGameScreen() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'block';
    document.getElementById('welcome-message').innerText = `Hello, ${username}!`;
}

// Logout functionality
function logout() {
    localStorage.removeItem('username');
    document.getElementById('game-screen').style.display = 'none';
    document.getElementById('login-screen').style.display = 'block';
}

// Open a pack and simulate blook draw
function openPack(packName) {
    const pack = packs[packName];
    const randomNum = Math.random() * 100;
    let cumulativeChance = 0;
    let drawnBlook;

    for (const blook of pack) {
        cumulativeChance += blook.chance;
        if (randomNum <= cumulativeChance) {
            drawnBlook = blook;
            break;
        }
    }

    // Update user's collection
    if (!userCollection[packName][drawnBlook.name]) {
        userCollection[packName][drawnBlook.name] = 0;
    }
    userCollection[packName][drawnBlook.name] += 1;
    localStorage.setItem('userCollection', JSON.stringify(userCollection));

    // Display result and show confetti animation based on rarity
    document.getElementById('pack-result').innerText = `You drew: ${drawnBlook.name} (${drawnBlook.rarity})`;
    showConfetti(drawnBlook.rarity);
}

// Confetti animation based on rarity
function showConfetti(rarity) {
    let confettiConfig = { spread: 45, startVelocity: 45, particleCount: 50 };
    if (rarity === 'Legendary' || rarity === 'Chroma' || rarity === 'Elusive') {
        confettiConfig = { ...confettiConfig, colors: ['#FFD700', '#FF0000'], particleCount: 100 };
    }
    confetti(confettiConfig);
}

// Open locker to view collected blooks
function openLocker() {
    let lockerContent = '';
    for (const packName in userCollection) {
        lockerContent += `<h3>${packName} Pack</h3>`;
        for (const blook in userCollection[packName]) {
            lockerContent += `<p>${blook}: ${userCollection[packName][blook]}</p>`;
        }
    }
    document.getElementById('locker-content').innerHTML = lockerContent;
    document.getElementById('locker').style.display = 'block';
}

// Close locker
function closeLocker() {
    document.getElementById('locker').style.display = 'none';
}

// Trading system placeholder
function startTrade() {
    alert('Trading system is coming soon!');
}
