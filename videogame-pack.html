<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Blicket | Video Game Pack</title>
  <link rel="icon" href="favicon.png" type="image/png" />
  <style>
    body {
      background-color: rgb(21, 14, 90);
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      position: relative;
      font-family: sans-serif;
      user-select: none;
    }
    .pack-wrapper {
      position: relative;
      width: 300px;
      height: 300px;
      cursor: pointer;
      z-index: 10;
    }
    .half {
      position: absolute;
      width: 100%;
      height: 50%;
      background-image: url('https://blacket.org/content/packs/Video%20Game.webp');
      background-size: cover;
      background-repeat: no-repeat;
      transition: transform 0.6s ease, opacity 0.6s ease;
    }
    .top-half {
      background-position: top;
      top: 0;
    }
    .bottom-half {
      background-position: bottom;
      bottom: 0;
    }
    .torn .top-half {
      transform: translateY(-150%) rotate(-15deg);
      opacity: 0;
    }
    .torn .bottom-half {
      transform: translateY(150%) rotate(15deg);
      opacity: 0;
    }
    #result {
      position: absolute;
      top: 60%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.1);
      font-size: 4.5rem;
      color: white;
      z-index: 15;
      transition: transform 0.1s ease;
      pointer-events: none;
      user-select: none;
    }
    #result img {
      width: 150px;
      height: auto;
      pointer-events: none;
      user-select: none;
    }
    .confetti-piece {
      position: fixed;
      width: 12px;
      height: 12px;
      opacity: 0.8;
      pointer-events: none;
      z-index: 20;
      border-radius: 2px;
      user-select: none;
    }
  </style>
</head>
<body>
  <div class="pack-wrapper" id="pack">
    <div id="result"></div>
    <div class="half top-half"></div>
    <div class="half bottom-half"></div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
let currentUser;
    const firebaseConfig = {
    apiKey: "AIzaSyA-wi0PMo1VUj8ES623IxUgb_AZGGQz4Bs",
    authDomain: "blicket-3dfc7.firebaseapp.com",
    projectId: "blicket-3dfc7",
    storageBucket: "blicket-3dfc7.appspot.com",
    messagingSenderId: "78883670759",
    appId: "1:78883670759:web:929f1ecd3bc95d0782f042"
  };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const PACK_COST = 25;
    const packWrapper = document.getElementById('pack');
    const result = document.getElementById('result');

    // Video Game Pack Blooks & odds
    const videoGamePack = {
      blooks: [
        { name: "https://blacket.org/content/blooks/Pac-Man.webp", chance: 13, rarity: 'uncommon' },
        { name: "https://blacket.org/content/blooks/Space%20Invader.webp", chance: 13, rarity: 'uncommon' },
        { name: "https://blacket.org/content/blooks/Among%20Us.webp", chance: 13, rarity: 'uncommon' },
        { name: "https://blacket.org/content/blooks/Poke%20Ball.webp", chance: 13, rarity: 'uncommon' },
        { name: "https://blacket.org/content/blooks/Flappy%20Bird.webp", chance: 13, rarity: 'uncommon' },
        { name: "https://blacket.org/content/blooks/Goomba.webp", chance: 7, rarity: 'rare' },
        { name: "https://blacket.org/content/blooks/Big%20Shield.webp", chance: 7, rarity: 'rare' },
        { name: "https://blacket.org/content/blooks/Creeper.webp", chance: 7, rarity: 'rare' },
        { name: "https://blacket.org/content/blooks/Red%20Bird.webp", chance: 5, rarity: 'epic' },
        { name: "https://blacket.org/content/blooks/Companion%20Cube.webp", chance: 5, rarity: 'epic' },
        { name: "https://blacket.org/content/blooks/Default.webp", chance: 1.5, rarity: 'legendary' },
        { name: "https://blacket.org/content/blooks/Enderman.webp", chance: 1.5, rarity: 'legendary' },
        { name: "https://blacket.org/content/blooks/Master%20Chief.webp", chance: 0.8, rarity: 'legendary' },
        { name: "https://blacket.org/content/blooks/Golden%20Among%20Us.webp", chance: 0.115, rarity: 'chroma' },
        { name: "https://blacket.org/content/blooks/Puffed%20Pig.webp", chance: 0.07, rarity: 'chroma' },
        { name: "https://blacket.org/content/blooks/Gaming%20Mouse.webp", chance: 0.015, rarity: 'mystical' }
      ]
    };

    // Pick blook based on weighted chances
    function getRandomBlook() {
      const rand = Math.random() * 100;
      let total = 0;
      for (const blook of videoGamePack.blooks) {
        total += blook.chance;
        if (rand <= total) return blook;
      }
      return videoGamePack.blooks[videoGamePack.blooks.length - 1]; // fallback
    }

    // Confetti spawning based on rarity and origin point
    function spawnConfetti(rarity, originX = window.innerWidth / 2, originY = window.innerHeight / 2) {
      const colors = {
        uncommon: ['#a0e060', '#88c040'],
        rare: ['#60b0e0', '#4080c0'],
        epic: ['#c060e0', '#a040c0'],
        legendary: ['#f7c338', '#d4a217'],
        chroma: ['#19c0f1', '#19c0f1'],
        mystical: ['#ffffff', '#ca17e6']
      };

      const countMap = {
        uncommon: 40,
        rare: 60,
        epic: 80,
        legendary: 100,
        chroma: 120,
        mystical: 150
      };

      const count = countMap[rarity] || 30;
      const colorSet = colors[rarity] || ['#ffffff'];

      for (let i = 0; i < count; i++) {
        const confetti = document.createElement('div');
        confetti.classList.add('confetti-piece');
        confetti.style.backgroundColor = colorSet[Math.floor(Math.random() * colorSet.length)];

        let startX = originX + (Math.random() - 0.5) * 150;
        let startY = originY + (Math.random() - 0.5) * 150;
        let velocityX = (Math.random() - 0.5) * 600;
        let velocityY = -Math.random() * 600 - 300;

        confetti.style.left = startX + 'px';
        confetti.style.top = startY + 'px';
        document.body.appendChild(confetti);

        const duration = Math.random() * 2 + 2;

        confetti.animate([
          { transform: 'translate(0, 0) rotate(0deg)', opacity: 1 },
          { transform: `translate(${velocityX}px, ${velocityY}px) rotate(${Math.random() * 360}deg)`, opacity: 0 }
        ], {
          duration: duration * 1000,
          iterations: 1,
          easing: 'ease-out'
        });

        setTimeout(() => confetti.remove(), duration * 1000);
      }
    }

    // Torn pack animation + result showing + saving to Firestore
    let clicked = false;
    packWrapper.addEventListener('click', async () => {
  if (clicked) return;
  if (!currentUser) {
    alert("Login not confirmed yet. Try again in a second.");
    return;
  }

  clicked = true;
  const userDocRef = db.collection('users').doc(currentUser.uid);
      try {
        const userDoc = await userDocRef.get();
        if (!userDoc.exists) {
          alert("User data missing, logging out.");
          await auth.signOut();
          window.location.href = "login.html";
          return;
        }
        const userData = userDoc.data();

        if ((userData.tokens ?? 0) < PACK_COST) {
          alert("You don't have enough tokens to open this pack.");
          window.location.href = "index.html";
          return;
        }

        // Deduct tokens atomically
        await userDocRef.update({
          tokens: firebase.firestore.FieldValue.increment(-PACK_COST)
        });

        // Animate torn pack
        packWrapper.classList.add('torn');

        // Get random blook
        const blook = getRandomBlook();

        // Show result blook image
        result.innerHTML = '';
        const img = document.createElement('img');
        img.src = blook.name;
        img.alt = 'Blook image';
        result.appendChild(img);

        // Animate blook appearing with a scale-up
        setTimeout(() => {
          result.style.transform = 'translate(-50%, -50%) scale(1)';
          const rect = result.getBoundingClientRect();
          spawnConfetti(blook.rarity, rect.left + rect.width / 2, rect.top + rect.height / 2);
        }, 700);

        // Save blook to user's collection in Firestore
        const collectionRef = userDocRef.collection('collection').doc(blook.name);
        const collectionDoc = await collectionRef.get();

        if (collectionDoc.exists) {
          await collectionRef.update({
            quantity: firebase.firestore.FieldValue.increment(1),
            rarity: blook.rarity
          });
        } else {
          await collectionRef.set({
            quantity: 1,
            rarity: blook.rarity
          });
        }

      } catch (error) {
        console.error("Error opening pack:", error);
        alert("There was an error. Try refreshing.");
        clicked = false;
        packWrapper.classList.remove('torn');
        result.style.transform = 'translate(-50%, -50%) scale(0.1)';
        result.innerHTML = '';
      }
    });

    // Redirect to login if user is not logged in
    auth.onAuthStateChanged(user => {
  if (!user) {
    setTimeout(() => {
      window.location.href = "login.html";
    }, 100);
  } else {
    currentUser = user;
  }
});
  </script>
</body>
</html>
